var L=Object.defineProperty;var N=(r,i,a)=>i in r?L(r,i,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[i]=a;var k=(r,i,a)=>N(r,typeof i!="symbol"?i+"":i,a);(function(){"use strict";class r{constructor(e){k(this,"_value");k(this,"subs",new Set);this._value=e}get value(){return P(this),this._value}set(e){if(!Object.is(e,this._value)){this._value=e;for(const n of Array.from(this.subs))try{n(this._value)}catch{}}}update(e){this.set(e(this._value))}subscribe(e){return this.subs.add(e),()=>this.subs.delete(e)}}const i=[],a=new WeakMap;function P(t){const e=i[i.length-1];if(!e)return;let n=a.get(t);n||(n=new Set,a.set(t,n)),n.add(e)}const c=new Set,p=t=>(c.add(t),()=>{clearTimeout(t),clearInterval(t),c.delete(t)});function u(t,e){self.postMessage({type:"log",level:t,args:e})}function y(t,e){self.postMessage({type:t,payload:e})}const m=new r(0),T=new r(null),b=new Map,v=new r({}),l=new r({}),w=new r({id:null,elements:[]}),C=new r([]),h=new Set,A={get value(){return v.value},subscribe:t=>v.subscribe(t)},R={get value(){return l.value},subscribe:t=>l.subscribe(t)},_={get value(){return w.value},subscribe:t=>w.subscribe(t)},j={readonly:t=>({get value(){return g(t)},subscribe:e=>d(t).subscribe(e)}),mutable:t=>d(t),get:t=>g(t),set:(t,e)=>S(t,e)},I=new Proxy(j,{get(t,e,n){return typeof e=="string"?e in t?Reflect.get(t,e,n):g(e):Reflect.get(t,e,n)},set(t,e,n){return typeof e=="string"?e in t?!1:(S(e,n),!0):!1},has(t,e){return typeof e=="string"&&!(e in t)?b.has(e):e in t},ownKeys(t){const e=new Set(Reflect.ownKeys(t));for(const n of b.keys())e.add(n);return Array.from(e)},getOwnPropertyDescriptor(t,e){return typeof e=="string"&&!(e in t)?{configurable:!0,enumerable:!0,value:g(e),writable:!0}:Reflect.getOwnPropertyDescriptor(t,e)}}),x={get value(){return l.value},get signal(){return R},onChange(t){return l.subscribe(t)},play(){y("timelineCommand",{action:"play"})},pause(){y("timelineCommand",{action:"pause"})},seek(t){y("timelineCommand",{action:"seek",time:t})}},V=new Proxy(x,{get(t,e,n){return typeof e=="string"&&!(e in t)?(l.value??{})[e]:Reflect.get(t,e,n)},set(t,e,n){return typeof e=="string"&&!(e in t)?(u("warn",[`Mava.timeline.${e} is read-only. Use play/pause/seek instead.`]),!1):Reflect.set(t,e,n)}});function O(t,e){C.set(t),new Map(t.map(n=>[n.id,n])),new Map(t.map(n=>[n.name??n.id,n])),w.set({id:e,elements:t})}const D={time:{get value(){return m.value},subscribe:t=>m.subscribe(t)},onTick(t){return h.add(t),()=>h.delete(t)},variables:I,timeline:V,builtin:{project:A,page:_},log:(...t)=>u("log",t),warn:(...t)=>u("warn",t),error:(...t)=>u("error",t),setTimeout(t,e){const n=setTimeout(t,e);return p(n)},setInterval(t,e){const n=setInterval(t,e);return p(n)},lerp:(t,e,n)=>t+(e-t)*n};function d(t){let e=b.get(t);return e||(e=new r(void 0),b.set(t,e)),e}function g(t){return d(t).value}function S(t,e){d(t).set(e)}let M=[];function E(t){for(const e of M.splice(0))try{e()}catch{}for(const e of Array.from(c))clearTimeout(e),clearInterval(e),c.delete(e);try{const e=new Function("Mava",`"use strict";
`+t),n=self.console;self.console={log:(...s)=>u("log",s),warn:(...s)=>u("warn",s),error:(...s)=>u("error",s)};try{const s=e(D);typeof s=="function"&&M.push(s)}finally{self.console=n}self.postMessage({type:"ran"})}catch(e){self.postMessage({type:"runtimeError",message:String((e==null?void 0:e.message)??e),stack:String((e==null?void 0:e.stack)??"")})}}onmessage=t=>{const{type:e,payload:n}=t.data||{};switch(e){case"run":return E(String((n==null?void 0:n.code)??""));case"stop":{for(const s of M.splice(0))try{s()}catch{}for(const s of Array.from(c))clearTimeout(s),clearInterval(s),c.delete(s);return self.postMessage({type:"stopped"})}case"setTime":{const{t:s,dt:f}=n||{t:0,dt:0};m.set(Number(s)||0);for(const o of Array.from(h))try{o(m.value,Number(f)||0)}catch{}return}case"setSelection":{T.set((n==null?void 0:n.id)??null);return}case"setVar":{const{name:s,value:f}=n||{};S(String(s),f);return}case"setBuiltin":{const{project:s,timeline:f,page:o}=n||{};if(s!==void 0&&v.set(s),f!==void 0&&l.set(f),o!==void 0){const F=(o==null?void 0:o.id)??null,K=Array.isArray(o==null?void 0:o.elements)?o.elements:[];O(K,F)}return}default:return}}})();
